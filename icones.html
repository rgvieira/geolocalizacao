
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Geo Painel v11.7 - Estabilidade Total</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{ --bg:#0f172a; --panel:#111827; --border:#334155; --text:#f8fafc; --muted:#94a3b8; --accent:#14532d; --darkred: #7f1d1d; }
*{box-sizing:border-box}
html, body { height: 100dvh; margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: system-ui; }
body { display: flex; flex-direction: column; }
header { background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 1000; }
.controls { padding: 8px; display: flex; gap: 6px; align-items: center; }
.controls button { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--accent); color: #fff; cursor: pointer; }
#map { height: 45vh; width: 100%; flex-shrink: 0; border-bottom: 1px solid var(--border); position: relative; z-index: 10; }

/* FIX DO BOTÃO DE MEDIÇÃO */
.leaflet-measure-btn { background: #fff !important; width: 34px !important; height: 34px !important; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; color: #333 !important; font-size: 16px; position: relative; z-index: 5000; }
.measure-menu { position: absolute; right: 42px; top: 0; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; display: none; flex-direction: column; min-width: 140px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 6000; }
.measure-menu.active { display: flex; }
.measure-menu button { background: none; border: none; color: #fff; padding: 10px 15px; text-align: left; font-size: 13px; cursor: pointer; border-bottom: 1px solid var(--border); }

.compass-icon { transition: transform 0.3s ease-out; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
.table-wrapper { flex-grow: 1; overflow: auto; background: var(--panel); }
table { width: 100%; border-collapse: collapse; font-size: .72rem; table-layout: fixed; }
th, td { padding: 12px 4px; border-bottom: 1px solid var(--border); text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
th { background: #020617; position: sticky; top: 0; z-index: 100; }

#drawer { position: fixed; left: 0; right: 0; bottom: -100%; background: var(--panel); border-top: 1px solid var(--border); border-radius: 14px 14px 0 0; padding: 12px; transition: .3s; z-index: 2000; }
#drawer.active { bottom: 0; }
.drawer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.drawer-grid input { height: 34px; border-radius: 6px; border: 1px solid var(--border); background: #020617; color: #fff; padding: 0 8px; font-size: .8rem; }
.drawer-actions { display: flex; gap: 4px; margin-top: 12px; }
.drawer-actions button { flex: 1; height: 40px; border-radius: 8px; border: 1px solid var(--border); background: var(--accent); color: white; cursor: pointer; }
</style>
</head>
<body>

<header>
  <div class="controls">
    <button id="addBtn"><i class="fa fa-plus"></i></button>
    <button id="uploadBtn"><i class="fa fa-upload"></i></button>
    <button id="downloadBtn"><i class="fa fa-download"></i></button>
    <button id="plotAllBtn" title="Plotar/Limpar Tudo"><i class="fa-solid fa-map-location-dot"></i></button>
    <div style="position:relative; flex:1">
      <i class="fa fa-search" style="position:absolute; left:10px; top:11px; color:var(--muted)"></i>
      <input id="search" placeholder="Buscar..." style="width:100%; height:36px; border-radius:8px; border:1px solid var(--border); padding-left:32px; background:#020617; color:#fff;">
    </div>
    <input type="file" id="csvFile" accept=".csv" hidden>
  </div>
</header>

<div id="map"></div>

<div class="table-wrapper">
  <table>
    <thead><tr><th style="width:30px">#</th><th>Tipo</th><th>Equip.</th><th style="width:40px">Az.</th><th>Lat</th><th>Lon</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="drawer">
  <form id="drawerForm">
    <div class="drawer-grid" id="drawerGrid"></div>
    <div class="drawer-actions">
      <button type="button" id="geoBtn"><i class="fa fa-location-crosshairs"></i></button>
      <button type="button" id="googleMapsBtn"><i class="fa-brands fa-google"></i></button>
      <button type="submit"><i class="fa fa-check"></i></button>
      <button type="button" id="deleteBtn" style="background:var(--darkred)"><i class="fa fa-trash"></i></button>
      <button type="button" onclick="closeDrawer()"><i class="fa fa-times"></i></button>
    </div>
  </form>
</div>

<script>
let nomeArquivoOriginal = null, tabelaGeo = [], filtered = [], selectedIndex = null, camadasAtivas = {}, clickTimer = null, isMeasuring = false;
const COLS = ["Tipo", "Equipamento", "Ativo", "Protocolo", "Azimute", "Latitude", "Longitude"];

// CAMADAS
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:18});
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19});

// NOVA TENTATIVA IBGE (LINK DIRETO E ESTÁVEL)
const ibge = L.tileLayer('https://tiles.arcgis.com/tiles/m87iXp9Y6vL695pM/arcgis/rest/services/IBGE_Mapas_Culturais/MapServer/tile/{z}/{y}/{x}', {
    attribution: '© IBGE',
    maxZoom: 18
});

const map = L.map('map', {layers:[sat], zoomControl:true, attributionControl:false}).setView([-20.32, -40.34], 14);
L.control.layers({ "Satélite": sat, "OpenStyle": osm, "IBGE": ibge }, null, {position: 'topright'}).addTo(map);

let markersCluster = L.markerClusterGroup(); map.addLayer(markersCluster);

// --- FUNÇÃO GPS (geoBtn) ---
document.getElementById('geoBtn').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6);
        if(confirm(`GPS: ${lat}, ${lon}. Adicionar?`)) {
            const iL = document.getElementById('inp_Latitude'), iO = document.getElementById('inp_Longitude');
            iL.value = iL.value ? iL.value + ' - ' + lat : lat;
            iO.value = iO.value ? iO.value + ' - ' + lon : lon;
        }
    }, (err) => alert("GPS Erro: " + err.message), {enableHighAccuracy:true});
};

// --- CLIQUE NO MAPA / CONCATENAÇÃO ---
map.on('click', (e) => {
    if (isMeasuring) return;
    if (document.getElementById("drawer").classList.contains("active")) {
        const lat = e.latlng.lat.toFixed(6), lon = e.latlng.lng.toFixed(6);
        const tempM = L.marker(e.latlng).addTo(map).bindTooltip(`Capturar ${lat}, ${lon}?`, {permanent:true}).openTooltip();
        setTimeout(() => {
            if(confirm(`Adicionar coordenada?`)) {
                const iL = document.getElementById('inp_Latitude'), iO = document.getElementById('inp_Longitude');
                iL.value = iL.value ? iL.value + ' - ' + lat : lat;
                iO.value = iO.value ? iO.value + ' - ' + lon : lon;
            }
            map.removeLayer(tempM);
        }, 100);
    }
});

// --- FUNÇÃO DE MEDIÇÃO (RÉGUA) ---
const CustomMeasure = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function() {
        const div = L.DomUtil.create('div', 'leaflet-measure-btn');
        div.innerHTML = `<i class="fa-solid fa-ruler-combined"></i><div class="measure-menu" id="mMenu"><button onclick="startMeasure('line')">Linha</button><button onclick="startMeasure('area')">Área</button><button onclick="clearMeasure()" style="color:#f87171">Limpar</button></div>`;
        div.onclick = (e) => { e.stopPropagation(); document.getElementById('mMenu').classList.toggle('active'); };
        return div;
    }
});
map.addControl(new CustomMeasure());
let measureGroup = L.layerGroup().addTo(map), mPoints = [], mShape = null;

function startMeasure(mode) { 
    clearMeasure(); isMeasuring = true; 
    map.on('click', (e) => {
        mPoints.push(e.latlng);
        if(mShape) map.removeLayer(mShape);
        mShape = (mode==='line') ? L.polyline(mPoints, {color:'#fbbf24', weight:4}).addTo(measureGroup) : L.polygon(mPoints, {color:'#fbbf24', fillOpacity:0.3}).addTo(measureGroup);
        if(mode==='line' && mPoints.length > 1) {
            let d = 0; for(let i=0; i<mPoints.length-1; i++) d += mPoints[i].distanceTo(mPoints[i+1]);
            mShape.bindTooltip(`${d.toFixed(1)}m`, {permanent:true}).openTooltip();
        }
    });
}
function clearMeasure() { isMeasuring = false; map.off('click'); measureGroup.clearLayers(); mPoints = []; mShape = null; document.getElementById('mMenu').classList.remove('active'); }

// --- PLOTAGEM ---
function getInfoTipo(r) {
    const t = (r.Tipo || "").toLowerCase(), az = r.Azimute && !isNaN(parseFloat(r.Azimute));
    if (t.includes('câmera')) return { fa: az ? 'fa-camera' : 'fa-video', color: '#ef4444' };
    if (t.includes('reta')) return { fa: 'fa-arrows-left-right', color: '#8b5cf6' };
    if (t.includes('área')) return { fa: 'fa-draw-polygon', color: '#10b981' };
    return { fa: 'fa-location-dot', color: '#3b82f6' };
}

function plotarRegistro(r, emMassa = false) {
    const lats = r.Latitude.toString().split(/[;]| - | , /).map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
    const lons = r.Longitude.toString().split(/[;]| - | , /).map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
    if (!lats.length) return [];
    let layers = [], info = getInfoTipo(r), az = parseFloat(r.Azimute);
    if (lats.length > 1) {
        const shape = L.polygon(lats.map((l, i) => [l, lons[i]]), {color: info.color, weight: 3}).addTo(map);
        layers.push(shape);
    } else {
        const coord = [lats[0], lons[0]];
        const icon = L.divIcon({ className: '', html: `<div style="background:${info.color}; width:28px; height:28px; border-radius:8px; border:2px solid #fff; color:#fff; display:flex; align-items:center; justify-content:center;"><i class="fa-solid ${info.fa}"></i></div>`, iconAnchor:[14,14] });
        const m = L.marker(coord, {icon: icon});
        if(!isNaN(az)) {
            const d = 0.00045, aRad = (az - 90) * Math.PI / 180;
            const p2 = [coord[0] + d * Math.cos(aRad - 0.4), coord[1] + d * Math.sin(aRad - 0.4)];
            const p3 = [coord[0] + d * Math.cos(aRad + 0.4), coord[1] + d * Math.sin(aRad + 0.4)];
            layers.push(L.polygon([coord, p2, p3], {color: info.color, weight:1, fillOpacity:0.3}).addTo(map));
            layers.push(L.marker(coord, {icon: L.divIcon({ className: '', html: `<div class="compass-icon" style="transform: rotate(${az}deg); color: #fff; font-size: 40px; text-shadow: 0 0 10px #000;"><i class="fa-solid fa-compass"></i></div>`, iconAnchor:[20,20] }), interactive: false}).addTo(map));
        }
        markersCluster.addLayer(m); layers.push(m);
    }
    if(!emMassa) map.setView([lats[0], lons[0]], 17);
    return layers;
}

// UI
function renderTable() {
    const tbody = document.getElementById("tbody"); tbody.innerHTML = "";
    filtered.forEach((r, i) => {
        const tr = document.createElement("tr"), info = getInfoTipo(r);
        tr.onclick = () => { if(clickTimer){ clearTimeout(clickTimer); clickTimer=null; openDrawer(i); } else { clickTimer = setTimeout(()=>{ clickTimer=null; toggleRegistro(r, i); }, 250); } };
        tr.innerHTML = `<td>${i+1}</td><td><i class="fa-solid ${info.fa}" style="color:${info.color}"></i> ${r.Tipo}</td><td>${r.Equipamento}</td><td>${r.Azimute}</td><td>${r.Latitude.toString().slice(0,7)}</td><td>${r.Longitude.toString().slice(0,7)}</td>`;
        tbody.appendChild(tr);
    });
}
function toggleRegistro(r, idx) {
    if (camadasAtivas[idx]) { camadasAtivas[idx].forEach(l => markersCluster.hasLayer(l) ? markersCluster.removeLayer(l) : map.removeLayer(l)); delete camadasAtivas[idx]; }
    else { camadasAtivas[idx] = plotarRegistro(r); }
}
function openDrawer(idx) { selectedIndex = idx; const grid = document.getElementById("drawerGrid"); grid.innerHTML = ""; COLS.forEach(c => grid.innerHTML += `<div><label>${c}</label><input id="inp_${c}" value="${filtered[idx][c]||''}"></div>`); document.getElementById("drawer").classList.add("active"); }
function closeDrawer() { document.getElementById("drawer").classList.remove("active"); }

document.getElementById('uploadBtn').onclick = () => document.getElementById('csvFile').click();
document.getElementById('csvFile').onchange = async e => {
    const file = e.target.files[0]; if(!file) return;
    nomeArquivoOriginal = file.name; const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim()), head = lines[0].split(",");
    const m = {}; COLS.forEach(c => m[c] = head.indexOf(c));
    tabelaGeo = lines.slice(1).map(l => { const v = l.split(","); let o = {}; COLS.forEach(c => o[c] = (m[c]!==-1 && v[m[c]]) ? v[m[c]].replace(/["']/g, '').trim() : ""); return o; });
    filtered = [...tabelaGeo]; renderTable();
};

document.getElementById('downloadBtn').onclick = () => {
    const link = document.createElement("a"); let csv = "\uFEFF" + COLS.join(",") + "\n";
    filtered.forEach(r => csv += COLS.map(c => `"${(r[c]||"").toString()}"`).join(",") + "\n");
    link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    link.download = nomeArquivoOriginal || "base.csv"; link.click();
};

document.getElementById('plotAllBtn').onclick = () => {
    const ativos = Object.keys(camadasAtivas);
    if(ativos.length > 0) ativos.forEach(idx => toggleRegistro(filtered[idx], idx));
    else filtered.forEach((r, i) => toggleRegistro(r, i));
};

document.getElementById('googleMapsBtn').onclick = () => {
    const lats = document.getElementById('inp_Latitude').value.split(/[;]| - | , /);
    const lons = document.getElementById('inp_Longitude').value.split(/[;]| - | , /);
    if (lats[0]) window.open(`https://www.google.com/maps?q=${lats[0].trim()},${lons[0].trim()}`, '_blank');
};

document.getElementById('drawerForm').onsubmit = e => { e.preventDefault(); COLS.forEach(c => filtered[selectedIndex][c] = document.getElementById('inp_'+c).value); renderTable(); closeDrawer(); };
document.getElementById('search').oninput = e => { const val = e.target.value.toLowerCase(); filtered = tabelaGeo.filter(r => Object.values(r).some(v => v.toString().toLowerCase().includes(val))); renderTable(); };
</script>
</body>
</html>
