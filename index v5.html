
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Geo Painel v9.6 - Clique para Coordenada</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --bg:#0f172a; --panel:#111827; --border:#334155;
  --text:#f8fafc; --muted:#94a3b8; --accent:#14532d;
  --darkred: #7f1d1d;
  --glass: rgba(15, 23, 42, 0.85);
}
*{box-sizing:border-box}
html, body { height: 100%; margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: system-ui; }
body { display: flex; flex-direction: column; }
header { background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 100; }

.controls { padding: 8px; display: flex; gap: 6px; align-items: center; }
.controls button { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--accent); color: #fff; cursor: pointer; }

#map { height: 45vh; width: 100%; flex-shrink: 0; border-bottom: 1px solid var(--border); position: relative; }

/* ALERTA GLASSMORPHISM */
#customAlert { 
    position: fixed; top: -150px; left: 50%; transform: translateX(-50%); 
    background: var(--glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border); color: #fff; padding: 14px 20px; 
    border-radius: 12px; font-weight: bold; z-index: 9999; 
    transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 300px; text-align: center; 
}
#customAlert.show { top: 15%; }

/* BOTÃO DE MEDIÇÃO ESTILO LEAFLET */
.leaflet-measure-btn {
    background: #fff; width: 34px; height: 34px; border-radius: 4px;
    border: 2px solid rgba(0,0,0,0.2); cursor: pointer; display: flex;
    align-items: center; justify-content: center; position: relative;
}
.leaflet-measure-btn i { color: #333; font-size: 16px; }
.measure-menu {
    position: absolute; right: 42px; top: 0; background: var(--panel); 
    border: 1px solid var(--border); border-radius: 8px; display: none; 
    flex-direction: column; min-width: 140px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
.measure-menu.active { display: flex; }
.measure-menu button { 
    background: none; border: none; color: #fff; padding: 10px 15px; text-align: left; 
    font-size: 13px; cursor: pointer; border-bottom: 1px solid var(--border);
}
.measure-menu button:hover { background: var(--accent); }

#compassContainer { position: absolute; bottom: 20px; right: 10px; width: 80px; height: 80px; z-index: 1000; background: rgba(15, 23, 42, 0.6); border-radius: 50%; pointer-events: none; border: 1px solid var(--border); backdrop-filter: blur(2px); }

.table-wrapper { flex-grow: 1; overflow: auto; background: var(--panel); }
table { width: 100%; border-collapse: collapse; font-size: .72rem; table-layout: fixed; }
th, td { padding: 12px 4px; border-bottom: 1px solid var(--border); text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
th { background: #020617; position: sticky; top: 0; z-index: 10; }

.map-btn-icon { display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 2px solid rgba(255,255,255,0.8); color: white; font-size: 16px; }
.geo-tooltip { background: rgba(15, 23, 42, 0.9) !important; border: 1px solid var(--border) !important; color: #fff !important; font-size: 11px; padding: 5px; }

#drawer { position: fixed; left: 0; right: 0; bottom: -100%; background: var(--panel); border-top: 1px solid var(--border); border-radius: 14px 14px 0 0; padding: 12px; transition: .3s; z-index: 1001; }
#drawer.active { bottom: 0; }
.drawer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.drawer-grid input, .drawer-grid select { height: 34px; border-radius: 6px; border: 1px solid var(--border); background: #020617; color: #fff; padding: 0 8px; font-size: .8rem; }
.drawer-actions { display: flex; gap: 6px; margin-top: 12px; }
.drawer-actions button { flex: 1; height: 40px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; }
</style>
</head>
<body>

<div id="customAlert"></div>

<header>
  <div class="controls">
    <button id="addBtn"><i class="fa fa-plus"></i></button>
    <button id="uploadBtn"><i class="fa fa-upload"></i></button>
    <button id="downloadBtn"><i class="fa fa-download"></i></button>
    <button id="plotAllBtn"><i class="fa-solid fa-map-location-dot"></i></button>
    <div style="position:relative; flex:1">
      <i class="fa fa-search" style="position:absolute; left:10px; top:11px; color:var(--muted)"></i>
      <input id="search" placeholder="Buscar..." style="width:100%; height:36px; border-radius:8px; border:1px solid var(--border); padding-left:32px; background:#020617; color:#fff;">
    </div>
    <input type="file" id="csvFile" accept=".csv" hidden>
  </div>
</header>

<div id="map">
    <div id="compassContainer"><canvas id="compassCanvas" width="80" height="80"></canvas></div>
</div>

<div class="table-wrapper">
  <table>
    <thead><tr><th style="width:30px">#</th><th>Tipo</th><th>Equip.</th><th style="width:40px">Az.</th><th>Lat</th><th>Lon</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="drawer">
  <form id="drawerForm">
    <div class="drawer-grid" id="drawerGrid"></div>
    <div class="drawer-actions">
      <button type="button" id="geoBtn" title="Usar GPS Atual"><i class="fa fa-location-crosshairs"></i></button>
      <button type="submit"><i class="fa fa-check"></i></button>
      <button type="button" id="deleteBtn" style="background:var(--darkred)"><i class="fa fa-trash"></i></button>
      <button type="button" onclick="closeDrawer()"><i class="fa fa-times"></i></button>
    </div>
  </form>
</div>

<script>
let nomeArquivoOriginal = "base_mapa.csv", tabelaGeo = [], filtered = [], selectedIndex = null, camadasAtivas = {}, clickTimer = null;
const COLS = ["Tipo", "Equipamento", "Ativo", "Protocolo", "Azimute", "Latitude", "Longitude"];

const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:18});
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19});
const map = L.map('map', {layers:[sat], zoomControl:true, attributionControl:false}).setView([-20.32, -40.34], 14);
L.control.layers({ "Satélite": sat, "Ruas": osm }, null, {position: 'topright'}).addTo(map);

// LÓGICA DE CLIQUE NO MAPA COM CARD ABERTO
map.on('click', (e) => {
    const drawer = document.getElementById("drawer");
    if (drawer.classList.contains("active")) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6);
        
        const tempM = L.marker(e.latlng).addTo(map).bindTooltip(`Lat: ${lat}<br>Lon: ${lon}`, {permanent:true}).openTooltip();
        
        setTimeout(() => {
            if(confirm(`Ponto clicado:\nLat: ${lat}\nLon: ${lon}\n\nAcrescentar ao registro atual?`)) {
                const iLat = document.getElementById('inp_Latitude'), iLon = document.getElementById('inp_Longitude');
                iLat.value = iLat.value ? `${iLat.value} - ${lat}` : lat;
                iLon.value = iLon.value ? `${iLon.value} - ${lon}` : lon;
                mostrarAlerta("Coordenadas adicionadas!");
            }
            map.removeLayer(tempM);
        }, 100);
    }
});

// FERRAMENTA DE MEDIÇÃO NATIVA
const CustomMeasure = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function() {
        const div = L.DomUtil.create('div', 'leaflet-measure-btn');
        div.innerHTML = `<i class="fa-solid fa-ruler-combined"></i>
            <div class="measure-menu" id="mMenu">
                <button onclick="startMeasure('line')"><i class="fa fa-arrows-left-right"></i> Medir Linha</button>
                <button onclick="startMeasure('area')"><i class="fa fa-draw-polygon"></i> Medir Área</button>
                <button onclick="clearMeasure()" style="color:#f87171"><i class="fa fa-eraser"></i> Limpar</button>
            </div>`;
        div.onclick = (e) => { e.stopPropagation(); document.getElementById('mMenu').classList.toggle('active'); };
        return div;
    }
});
map.addControl(new CustomMeasure());

let measureGroup = L.layerGroup().addTo(map), mPoints = [], mShape = null;
function startMeasure(mode) {
    clearMeasure(); mostrarAlerta(`Modo ${mode === 'line' ? 'Distância' : 'Área'} ativo.`);
    map.on('click', (e) => {
        // Bloqueia medição se o drawer estiver aberto para não conflitar com a função de capturar coordenada
        if(document.getElementById("drawer").classList.contains("active")) return;
        mPoints.push(e.latlng);
        if(mShape) map.removeLayer(mShape);
        if(mode === 'line') {
            mShape = L.polyline(mPoints, {color: '#fbbf24', weight: 4}).addTo(measureGroup);
            if(mPoints.length > 1) {
                let d = 0; for(let i=0; i<mPoints.length-1; i++) d += mPoints[i].distanceTo(mPoints[i+1]);
                mShape.bindTooltip(`${d.toFixed(1)}m`, {permanent:true, direction:'center'}).openTooltip();
            }
        } else {
            mShape = L.polygon(mPoints, {color: '#fbbf24', fillOpacity: 0.3}).addTo(measureGroup);
            if(mPoints.length > 2) mShape.bindTooltip(`Área Ativa`, {permanent:true, direction:'center'}).openTooltip();
        }
    });
}
function clearMeasure() { map.off('click'); measureGroup.clearLayers(); mPoints = []; mShape = null; document.getElementById('mMenu').classList.remove('active'); }

// GPS RESTAURADO
document.getElementById('geoBtn').onclick = () => {
    mostrarAlerta("Buscando GPS...");
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6);
        const tempMarker = L.marker([lat, lon]).addTo(map).bindTooltip(`Precisão: ${pos.coords.accuracy.toFixed(1)}m`, {permanent:true}).openTooltip();
        map.setView([lat, lon], 18);
        setTimeout(() => {
            if(confirm(`GPS Localizado!\nConcatenar no registro?`)) {
                const iLat = document.getElementById('inp_Latitude'), iLon = document.getElementById('inp_Longitude');
                iLat.value = iLat.value ? `${iLat.value} - ${lat}` : lat;
                iLon.value = iLon.value ? `${iLon.value} - ${lon}` : lon;
            }
            map.removeLayer(tempMarker);
        }, 500);
    }, (err) => mostrarAlerta("Erro GPS"), {enableHighAccuracy:true});
};

function mostrarAlerta(msg) {
    const el = document.getElementById('customAlert');
    el.innerText = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}

// PLOTAGEM V9.1
function getInfoTipo(r) {
    const t = (r.Tipo || "").toLowerCase(), az = r.Azimute && !isNaN(parseFloat(r.Azimute));
    if (t.includes('câmera') || t.includes('camera')) return { fa: az ? 'fa-camera' : 'fa-video', color: '#ef4444' };
    if (t.includes('reta')) return { fa: 'fa-arrows-left-right', color: '#8b5cf6' };
    if (t.includes('área')) return { fa: 'fa-draw-polygon', color: '#10b981' };
    return { fa: 'fa-location-dot', color: '#3b82f6' };
}

function plotarRegistro(r, emMassa = false) {
    const lats = r.Latitude.toString().split(/[;]| - | , /).map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
    const lons = r.Longitude.toString().split(/[;]| - | , /).map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
    if (!lats.length) return [];
    let layers = [], info = getInfoTipo(r);
    if (lats.length > 1) {
        const shape = L.polygon(lats.map((l, i) => [l, lons[i]]), {color: info.color, weight: 3}).addTo(map);
        layers.push(shape);
    } else {
        const coord = [lats[0], lons[0]];
        const icon = L.divIcon({ className: '', html: `<div class="map-btn-icon" style="background:${info.color}; width:28px; height:28px;"><i class="fa-solid ${info.fa}"></i></div>`, iconSize:[28,28], iconAnchor:[14,14] });
        const m = L.marker(coord, {icon: icon});
        const az = parseFloat(r.Azimute);
        if(!isNaN(az) && (r.Tipo||"").toLowerCase().includes('camera')) {
            const d = 0.00045, p2 = [coord[0]+d*Math.cos((az-125)*Math.PI/180), coord[1]+d*Math.sin((az-125)*Math.PI/180)], p3 = [coord[0]+d*Math.cos((az-55)*Math.PI/180), coord[1]+d*Math.sin((az-55)*Math.PI/180)];
            layers.push(L.polygon([coord, p2, p3], {color: info.color, weight:1, fillOpacity:0.2}).addTo(map));
        }
        markersCluster.addLayer(m); layers.push(m);
    }
    layers.forEach(l => l.bindTooltip(r.Equipamento, {className:'geo-tooltip'}));
    if(!emMassa) map.setView([lats[0], lons[0]], 17);
    return layers;
}

function renderTable() {
    const tbody = document.getElementById("tbody"); tbody.innerHTML = "";
    filtered.forEach((r, i) => {
        const tr = document.createElement("tr"), info = getInfoTipo(r);
        tr.onclick = () => {
            if(clickTimer){ clearTimeout(clickTimer); clickTimer=null; openDrawer(i); }
            else { clickTimer = setTimeout(()=>{ clickTimer=null; toggleRegistro(r, i); }, 250); }
        };
        tr.innerHTML = `<td>${i+1}</td><td><i class="fa-solid ${info.fa}" style="color:${info.color}"></i> ${r.Tipo}</td><td>${r.Equipamento}</td><td>${r.Azimute}</td><td>${r.Latitude.toString().slice(0,7)}</td><td>${r.Longitude.toString().slice(0,7)}</td>`;
        tbody.appendChild(tr);
    });
}

function toggleRegistro(r, idx) {
    if (camadasAtivas[idx]) {
        camadasAtivas[idx].forEach(l => markersCluster.hasLayer(l) ? markersCluster.removeLayer(l) : map.removeLayer(l));
        delete camadasAtivas[idx];
    } else { camadasAtivas[idx] = plotarRegistro(r); }
}

function openDrawer(idx) {
    selectedIndex = idx; const grid = document.getElementById("drawerGrid"); grid.innerHTML = "";
    COLS.forEach(c => {
        if(c === "Ativo") {
            const v = (filtered[idx][c] === "true" || filtered[idx][c] === "Sim") ? "Sim" : "Não";
            grid.innerHTML += `<div><label>${c}</label><select id="inp_${c}"><option value="Sim" ${v==='Sim'?'selected':''}>Sim</option><option value="Não" ${v==='Não'?'selected':''}>Não</option></select></div>`;
        } else grid.innerHTML += `<div><label>${c}</label><input id="inp_${c}" value="${filtered[idx][c]||''}"></div>`;
    });
    document.getElementById("drawer").classList.add("active");
}

function closeDrawer() { document.getElementById("drawer").classList.remove("active"); }

document.getElementById('drawerForm').onsubmit = e => {
    e.preventDefault(); COLS.forEach(c => filtered[selectedIndex][c] = document.getElementById('inp_'+c).value);
    renderTable(); closeDrawer();
};

document.getElementById('downloadBtn').onclick = () => {
    let csv = "\uFEFF" + COLS.join(",") + "\n";
    filtered.forEach(r => {
        csv += COLS.map(c => {
            let v = (r[c]||"").toString();
            if(c === "Ativo") v = (v === "Sim" || v === "true") ? "true" : "false";
            if(c === "Latitude" || c === "Longitude") v = v.replaceAll(/[;]| , /g, ' - ');
            return `"${v}"`;
        }).join(",") + "\n";
    });
    const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    link.download = nomeArquivoOriginal; link.click();
};

document.getElementById('plotAllBtn').onclick = () => {
    filtered.forEach((r, i) => { if(!camadasAtivas[i]) toggleRegistro(r, i); });
    mostrarAlerta("Plotado!");
};

document.getElementById('search').oninput = e => {
    const val = e.target.value.toLowerCase();
    filtered = tabelaGeo.filter(r => Object.values(r).some(v => v.toString().toLowerCase().includes(val)));
    renderTable();
};

document.getElementById('addBtn').onclick = () => { 
    tabelaGeo.push({Tipo: "Ponto", Equipamento: "Novo", Ativo: "Sim", Azimute: "", Latitude: "", Longitude: ""}); 
    filtered = [...tabelaGeo]; renderTable(); openDrawer(filtered.length-1); 
};

document.getElementById('uploadBtn').onclick = () => document.getElementById('csvFile').click();
document.getElementById('csvFile').onchange = async e => {
    const file = e.target.files[0]; if(!file) return;
    nomeArquivoOriginal = file.name; const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const head = lines[0].split(","); const m = {}; COLS.forEach(c => m[c] = head.indexOf(c));
    tabelaGeo = lines.slice(1).map(l => {
        const v = l.split(","); let o = {};
        COLS.forEach(c => {
            let val = (m[c]!==-1 && v[m[c]]) ? v[m[c]].replace(/["']/g, '').trim() : "";
            if(c === "Ativo") val = (val === "true" || val === "Sim") ? "Sim" : "Não";
            o[c] = val;
        });
        return o;
    });
    filtered = [...tabelaGeo]; renderTable(); mostrarAlerta("CSV Importado!");
};

let markersCluster = L.markerClusterGroup(); map.addLayer(markersCluster);
</script>
</body>
</html>
