
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />

<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>

<title>Geo Painel v10.7 - Full Preservation</title>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --border:#334155;
  --text:#f8fafc; --muted:#94a3b8; --accent:#14532d;
  --darkred: #7f1d1d;
  --glass: rgba(15, 23, 42, 0.85);
  --google-blue: #4285F4;
}
*{box-sizing:border-box}
html, body { 
    height: 100dvh; margin: 0; overflow: hidden; 
    background: var(--bg); color: var(--text); font-family: system-ui;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
body { display: flex; flex-direction: column; }
header { background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 100; }

.controls { padding: 8px; display: flex; gap: 6px; align-items: center; }
.controls button { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--accent); color: #fff; cursor: pointer; }

#map { height: 45vh; width: 100%; flex-shrink: 0; border-bottom: 1px solid var(--border); position: relative; }
.map-footer {
    transition: opacity 0.3s ease;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    border: 1px solid var(--border);
    max-width: 300px;
}
#customAlert { 
    position: fixed; top: -150px; left: 50%; transform: translateX(-50%); 
    background: var(--glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border); color: #fff; padding: 14px 20px; 
    border-radius: 12px; font-weight: bold; z-index: 9999; 
    transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 300px; text-align: center; 
}
#customAlert.show { top: 15%; }
/* Garante que o container da direita permita o empilhamento correto */
.leaflet-top.leaflet-right {
    display: flex !important;
    flex-direction: column !important;
    align-items: flex-end !important;
    z-index: 1000 !important;
}

/* For√ßa TODOS os blocos de controle a serem vis√≠veis */
.leaflet-right .leaflet-control {
    display: block !important;
    margin-right: 12px !important;
    margin-top: 5px !important;
    margin-bottom: 0 !important;
    position: relative !important;
    float: none !important;
    clear: both !important;
}

/* PADRONIZA√á√ÉO ABSOLUTA DE TAMANHO */
/* Zoom, Camadas, Geoman/R√©gua e seu GPS */
.leaflet-control-zoom a,
.leaflet-control-layers-toggle,
.leaflet-pm-toolbar button,
.leaflet-buttons-control-button,
#geoBtn {
    width: 34px !important;
    height: 34px !important;
    background-color: #1a1a1a !important;
    color: white !important;
    border: none !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
    text-decoration: none !important;
}

/* Ajuste espec√≠fico para o √≠cone de camadas (que costuma sumir) */
.leaflet-control-layers-toggle {
    background-image: none !important;
}
.leaflet-control-layers-toggle::before {
    content: '\f5fd'; 
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    font-size: 15px;
}

.measure-menu {
    position: absolute; right: 42px; top: 0; background: var(--panel); 
    border: 1px solid var(--border); border-radius: 8px; display: none; 
    flex-direction: column; min-width: 140px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
.measure-menu.active { display: flex; }
.measure-menu button { 
    background: none; border: none; color: #fff; padding: 10px 15px; text-align: left; 
    font-size: 13px; cursor: pointer; border-bottom: 1px solid var(--border);
}

.compass-icon { transition: transform 0.3s ease-out; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

.table-wrapper { flex-grow: 1; overflow: auto; background: var(--panel); }
table { width: 100%; border-collapse: collapse; font-size: .72rem; table-layout: fixed; }
th, td { padding: 12px 4px; border-bottom: 1px solid var(--border); text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
th { background: #020617; position: sticky; top: 0; z-index: 10; }

#drawer { position: fixed; left: 0; right: 0; bottom: -100%; background: var(--panel); border-top: 1px solid var(--border); border-radius: 14px 14px 0 0; padding: 12px; transition: .3s; z-index: 1001; }
#drawer.active { bottom: 0; }
.drawer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.drawer-grid input, .drawer-grid select { height: 34px; border-radius: 6px; border: 1px solid var(--border); background: #020617; color: #fff; padding: 0 8px; font-size: .8rem; }
.drawer-actions { display: flex; gap: 4px; margin-top: 12px; flex-wrap: wrap; }
.drawer-actions button { flex: 1; min-width: 40px; height: 40px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; }

</style>
</head>
<body>

<div id="customAlert"></div>

<header>
  <div class="controls">
    <button id="addBtn"><i class="fa fa-plus"></i></button>
    <button id="uploadBtn"><i class="fa fa-upload"></i></button>
    <button id="downloadBtn"><i class="fa fa-download"></i></button>
    <button id="plotAllBtn"><i class="fa-solid fa-map-location-dot"></i></button>
    <div style="position:relative; flex:1">
      <i class="fa fa-search" style="position:absolute; left:10px; top:11px; color:var(--muted)"></i>
      <input id="search" placeholder="Buscar..." style="width:100%; height:36px; border-radius:8px; border:1px solid var(--border); padding-left:32px; background:#020617; color:#fff;">
    </div>
    <input type="file" id="csvFile" accept=".csv" hidden>
  </div>
</header>

<div id="map"></div>

<input type="file" id="localTileInput" webkitdirectory directory multiple hidden>
<div class="table-wrapper">
  <table>
    <thead><tr><th style="width:30px">#</th><th>Tipo</th><th>Equip.</th><th style="width:40px">Az.</th><th>Lat</th><th>Lon</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="drawer">
  <form id="drawerForm">
    <div class="drawer-grid" id="drawerGrid"></div>
    <div class="drawer-actions">
      <button type="button" id="geoBtn" title="GPS"><i class="fa fa-location-crosshairs"></i></button>
      <button type="button" id="googleMapsBtn"  title="Ver no Google Maps"><i class="fa-brands fa-google"></i></button>
      <button type="submit" title="Salvar"><i class="fa fa-check"></i></button>
      <button type="button" id="deleteBtn" style="background:var(--darkred)" title="Excluir"><i class="fa fa-trash"></i></button>
      <button type="button" onclick="closeDrawer()" title="Fechar"><i class="fa fa-times"></i></button>
    </div>
  </form>
</div>

<div id="mapSelector" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--panel); border:1px solid var(--border); padding:20px; border-radius:12px; z-index:10002; width:300px; box-shadow:0 0 20px rgba(0,0,0,0.5);">
    <h3 style="margin-top:0; font-size:16px;">Arquivos no Servidor</h3>
    <select id="zipSelect" style="width:100%; height:36px; background:#020617; color:white; border:1px solid var(--border); border-radius:6px; margin-bottom:15px;">
        <option value="">Selecione um arquivo...</option>
        <option value="municipios_es">Munic√≠pios ES (IBGE)</option>
        <option value="setores_censitarios">Setores Censit√°rios</option>
        <option value="limites_preservacao">Limites de Preserva√ß√£o</option>
    </select>
    <div style="display:flex; gap:10px;">
        <button onclick="confirmarCarregamento()" style="flex:1; background:var(--accent); color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">Carregar</button>
        <button onclick="document.getElementById('mapSelector').style.display='none'" style="flex:1; background:var(--darkred); color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">Cancelar</button>
    </div>
</div>
<select id="zipSelect" style="width:100%; height:36px; background:#020617; color:white; border:1px solid var(--border); border-radius:6px; margin-bottom:15px;">
    <option value="">Carregando lista...</option>
</select>
<script>
let nomeArquivoOriginal = null, tabelaGeo = [], filtered = [], selectedIndex = null, camadasAtivas = {}, clickTimer = null;
const COLS = ["Tipo", "Equipamento", "Ativo", "Protocolo", "Azimute", "Latitude", "Longitude"];

// 1. DEFINI√á√ÉO DOS TILES (MAPAS)
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:18});
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19});

// 3. CRIA√á√ÉO DA CAMADA VAZIA (O "gatilho" para o seletor)
// Definimos aqui no topo para que o baseMaps possa enxerg√°-la
const mapaLocalVazio = L.tileLayer('', { attribution: 'IBGE / Local' });

// Adicione isso logo no in√≠cio das vari√°veis globais
const CONFIG_MAPAS = {

    "ES_Municipios_2024": 19,
       "Regi√µes Geogr√°ficas Imediatas": 20,
        "Regi√µes Geogr√°ficas Intermedi√°rias" : 21, 
    "ES_UF_2024": 17        // Mapa geral, n√£o precisa de tanto zoom
};

    



// 2. INICIALIZA√á√ÉO DO MAPA
const map = L.map('map', {
    layers: [sat], 
    zoomControl: false, 
    attributionControl: false
}).setView([-20.32, -40.34], 14);


map.setMaxZoom(limiteZoom);


// 3. DEFINI√á√ÉO DAS CAMADAS PARA O BOT√ÉO
let markersCluster = L.markerClusterGroup(); 
const baseMaps = { 
    "Sat√©lite": sat, 
    "Ruas": osm,
    "Carregar Mapa Local": mapaLocalVazio // Op√ß√£o que disparar√° o clique
};

const overlayMaps = { "Agrupamento": markersCluster };

map.addLayer(markersCluster);



// 2. Adiciona o controle normalmente
const layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

window.layerControl = layerControl;

// Fun√ß√£o para garantir que os bot√µes apare√ßam

function initControls() {
    // 1. Zoom
    L.control.zoom({ position: 'topright' }).addTo(map);
    // 3. Camadas
    L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

    // 2. R√©gua (Geoman)
    if (map.pm) {
        map.pm.addControls({
            position: 'topright',
            drawMarker: false,
            drawPolyline: true, // R√©gua
            drawRectangle: false,
            drawPolygon: false,
            drawCircle: false,
            removalMode: true,
            editMode: false,
            dragMode: false,
            cutPolygon: false
        });
        // 1. Ativa o Portugu√™s
        map.pm.setLang('pt_br');
    }


    // 4. GPS (Como controle oficial)
    const GPSCtrl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function() {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            container.innerHTML = `<a id="geoBtn" title="GPS" style="cursor:pointer; display:flex; align-items:center; justify-content:center; background:#1a1a1a; color:white; width:34px; height:34px;">
                <i class="fa fa-location-crosshairs"></i>
            </a>`;
            container.onclick = (e) => { e.preventDefault(); pegarGPS(); };
            return container;
        }
    });
    map.addControl(new GPSCtrl());
}

// Fun√ß√£o para carregar a lista de mapas do JSON
async function carregarListaDeMapas() {
    const select = document.getElementById('zipSelect');
    
    // Lista de backup caso o fetch falhe (CORS ou arquivo ausente)
    const listaBackup = [

        { "nome": "Munic√≠pios do ES (2024)", "arquivo": "ES_Municipios_2024" },
        { "nome": "Regi√µes Geogr√°ficas Imediatas", "arquivo": "ES_RG_Imediatas_2024" },
        { "nome": "Regi√µes Geogr√°ficas Intermedi√°rias", "arquivo": "ES_RG_Intermediarias_2024" },
        { "nome": "Estado do Esp√≠rito Santo (UF)", "arquivo": "ES_UF_2024" }
    ];

    try {
        const response = await fetch('./lista.json');
        if (!response.ok) throw new Error("Usando lista de backup");
        
        let mapas = await response.json();
        renderizarSelect(mapas);
        //console.log("Lista carregada via JSON do servidor.");

    } catch (err) {
        // Se der erro de CORS ou 404, ele usa a lista abaixo
        console.warn("CORS/Erro detectado. Carregando lista est√°vel do c√≥digo.");
        renderizarSelect(listaBackup);
        console.log(listaBackup)
    }

    function renderizarSelect(dados) {
        dados.sort((a, b) => a.nome.localeCompare(b.nome));
        select.innerHTML = '<option value="">Selecione um mapa...</option>';
        dados.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.arquivo;
            opt.textContent = item.nome;
            select.appendChild(opt);
        });
    }
}
// Inicia a carga assim que o mapa estiver pronto
map.whenReady(carregarListaDeMapas);

// Fun√ß√£o de confirma√ß√£o de carregamento (Ajustada)
async function confirmarCarregamento() {
    const nomeArquivo = document.getElementById('zipSelect').value;
    const nomeExibicao = document.getElementById('zipSelect').options[document.getElementById('zipSelect').selectedIndex].text;
    
    if (!nomeArquivo) return;

    document.getElementById('mapSelector').style.display = 'none';
    mapaStatus.update(`‚è≥ Carregando ${nomeExibicao}...`);

    try {
        const response = await fetch(`./${nomeArquivo}.zip`);
        if (!response.ok) throw new Error("Arquivo ZIP n√£o encontrado no servidor.");
        
        const buffer = await response.arrayBuffer();
        const geojson = await shp(buffer);

        const camada = L.geoJSON(geojson, {
            style: { 
                color: "#1e40af", 
                weight: 2,       // Aumentamos um pouco para o contorno ficar bem vis√≠vel
                opacity: 1,      // Linha 100% s√≥lida
                fill: false      // Remove o preenchimento (fica transparente por dentro)
            },
            onEachFeature: (f, layer) => {
                // Seu c√≥digo da tabela/popup...
            }
        }).addTo(map);

        // A. Identificamos qual arquivo foi carregado (ajuste o 'id_do_select' para o seu)
        const arquivoAtual = document.getElementById('id_do_select').value;

        // B. Ajustamos o zoom m√°ximo permitido
        const maxZoomDefinido = CONFIG_MAPAS[arquivoAtual] || 18;
        map.setMaxZoom(maxZoomDefinido);

        // C. Zoom autom√°tico para enquadrar o mapa
        map.flyToBounds(camada.getBounds(), {
            padding: [30, 30],
            duration: 1.5
        });
        // Adiciona ao controle de camadas (Overlay)
        if (window.layerControl) {
            window.layerControl.addOverlay(camada, nomeExibicao);
        }
        
        map.fitBounds(camada.getBounds());
        mapaStatus.update(`‚úÖ ${nomeExibicao} carregado com sucesso.`);
        
        // Limpa a mensagem ap√≥s 5 segundos
        setTimeout(() => mapaStatus.update(""), 5000);

    } catch (err) {
        console.error(err);
        mapaStatus.update(`‚ùå Erro ao carregar: ${nomeArquivo}`);
    }
}

// Executa a cria√ß√£o dos bot√µes ap√≥s o mapa estar pronto
map.whenReady(() => {
    setTimeout(initControls, 100);
});

// Fun√ß√£o para carregar ZIP (Shapefile) do servidor
async function carregarZipDoServidor(nomeArquivo) {
    try {
        mapaStatus.update("‚è≥ Processando arquivo do IBGE...");
        
        // Faz a requisi√ß√£o do arquivo ZIP que est√° na pasta do seu servidor
        const response = await fetch(`./mapas/${nomeArquivo}.zip`);
        const buffer = await response.arrayBuffer();
        
        // A biblioteca shpjs extrai o ZIP e converte para GeoJSON automaticamente
        const geojson = await shp(buffer);
        
        const camadaIBGE = L.geoJSON(geojson, {
            style: {
                color: "#1d4ed8",
                weight: 2,
                fillOpacity: 0.2
            },
            onEachFeature: (feature, layer) => {
                // Tenta pegar o nome da localidade se existir nos dados do IBGE
                const nome = feature.properties.NM_MUN || feature.properties.NM_BAIRRO || "√Årea IBGE";
                layer.bindPopup(`<b>Local:</b> ${nome}`);
            }
        }).addTo(map);

        // Adiciona ao menu de camadas para o usu√°rio poder ligar/desligar
        layerControl.addOverlay(camadaIBGE, "IBGE: " + nomeArquivo);
        
        // Ajusta o zoom para a √°rea do arquivo carregado
        map.fitBounds(camadaIBGE.getBounds());
        mapaStatus.update("‚úÖ Camada carregada com sucesso!");

    } catch (err) {
        console.error(err);
        mapaStatus.update("‚ùå Erro ao carregar o ZIP do servidor.");
    }
}
/*
// Gatilho no menu de camadas
map.on('baselayerchange', function(e) {
    if (e.name === "Carregar Mapa Local") {
        // Exemplo: solicita o nome do arquivo que est√° na pasta do servidor
        let arquivo = prompt("Digite o nome do arquivo ZIP no servidor (sem .zip):", "municipios_es");
        if(arquivo) carregarZipDoServidor(arquivo);
    }
});

*/
// Monitora a troca de camada para abrir o seletor
map.on('baselayerchange', function(e) {
    if (e.name === "Carregar Mapa Local") {
        // Volta para o sat√©lite para n√£o deixar a camada "vazia" ativa
        map.addLayer(sat); 
        document.getElementById('mapSelector').style.display = 'block';
    }
});


function activateFullscreen() {
    const el = document.documentElement;
    if (el.requestFullscreen) el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}

function getInfoTipo(r) {
    const t = (r.Tipo || "").toLowerCase(), az = r.Azimute && !isNaN(parseFloat(r.Azimute));
    if (t.includes('c√¢mera')) return { fa: az ? 'fa-camera' : 'fa-video', color: '#ef4444' };
    if (t.includes('reta')) return { fa: 'fa-arrows-left-right', color: '#8b5cf6' };
    if (t.includes('√°rea')) return { fa: 'fa-draw-polygon', color: '#10b981' };
    return { fa: 'fa-location-dot', color: '#3b82f6' };
}

function plotarRegistro(r, emMassa = false) {
    const lats = r.Latitude.toString().split(/[;]| - | , /).map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
    const lons = r.Longitude.toString().split(/[;]| - | , /).map(n => parseFloat(n.trim())).filter(n => !isNaN(n));
    if (!lats.length) return [];
    
    let layers = [], info = getInfoTipo(r);
    const az = parseFloat(r.Azimute);
    
    if (lats.length > 1) {
        const shape = L.polygon(lats.map((l, i) => [l, lons[i]]), {color: info.color, weight: 3}).addTo(map);
        layers.push(shape);
    } else {
        const coord = [lats[0], lons[0]];
        const icon = L.divIcon({ className: '', html: `<div style="background:${info.color}; width:28px; height:28px; border-radius:8px; border:2px solid #fff; color:#fff; display:flex; align-items:center; justify-content:center;"><i class="fa-solid ${info.fa}"></i></div>`, iconAnchor:[14,14] });
        const m = L.marker(coord, {icon: icon});
        
        if(!isNaN(az)) {
            const d = 0.00045;
            const aRad = (az - 90) * Math.PI / 180;
            const p2 = [coord[0] + d * Math.cos(aRad - 0.4), coord[1] + d * Math.sin(aRad - 0.4)];
            const p3 = [coord[0] + d * Math.cos(aRad + 0.4), coord[1] + d * Math.sin(aRad + 0.4)];
            const cone = L.polygon([coord, p2, p3], {color: info.color, weight:1, fillOpacity:0.3}).addTo(map);
            layers.push(cone);

            const compassHtml = `<div class="compass-icon" style="transform: rotate(${az}deg); color: #fff; font-size: 40px; text-shadow: 0 0 10px #000;"><i class="fa-solid fa-compass"></i></div>`;
            const compassIcon = L.divIcon({ className: '', html: compassHtml, iconAnchor:[20,20] });
            const compassMarker = L.marker(coord, {icon: compassIcon, zIndexOffset: -100, interactive: false}).addTo(map);
            layers.push(compassMarker);
        }
        markersCluster.addLayer(m); layers.push(m);
    }
    layers.forEach(l => { if(l.bindTooltip) l.bindTooltip(`<b>${r.Equipamento}</b>`, {permanent: false}); });
    if(!emMassa) map.setView([lats[0], lons[0]], 17);
    return layers;
}

function renderTable() {
    const tbody = document.getElementById("tbody"); tbody.innerHTML = "";
    filtered.forEach((r, i) => {
        const tr = document.createElement("tr"), info = getInfoTipo(r);
        tr.onclick = () => {
            if(clickTimer){ clearTimeout(clickTimer); clickTimer=null; openDrawer(i); }
            else { clickTimer = setTimeout(()=>{ clickTimer=null; toggleRegistro(r, i); }, 250); }
        };
        tr.innerHTML = `<td>${i+1}</td><td><i class="fa-solid ${info.fa}" style="color:${info.color}"></i> ${r.Tipo}</td><td>${r.Equipamento}</td><td>${r.Azimute}</td><td>${r.Latitude.toString().slice(0,7)}</td><td>${r.Longitude.toString().slice(0,7)}</td>`;
        tbody.appendChild(tr);
    });
}

function toggleRegistro(r, idx) {
    if (camadasAtivas[idx]) {
        camadasAtivas[idx].forEach(l => markersCluster.hasLayer(l) ? markersCluster.removeLayer(l) : map.removeLayer(l));
        delete camadasAtivas[idx];
    } else { camadasAtivas[idx] = plotarRegistro(r); }
}

// GOOGLE MAPS EXTERNO (GRATUITO)
document.getElementById('googleMapsBtn').onclick = () => {
    const lat = document.getElementById('inp_Latitude').value.split(' - ')[0];
    const lon = document.getElementById('inp_Longitude').value.split(' - ')[0];
    if(lat && lon) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`, '_blank');
    } else { mostrarAlerta("Coordenadas ausentes."); }
};

document.getElementById('downloadBtn').onclick = () => {
    let nomeFinal = nomeArquivoOriginal;
    if (!nomeFinal) {
        let inputNome = prompt("Nome do arquivo:", "meu_mapa");
        if (inputNome === null) return;
        nomeFinal = inputNome.trim() ? inputNome.trim() + ".csv" : "base_geopainel.csv";
    }
    let csv = "\uFEFF" + COLS.join(",") + "\n";
    filtered.forEach(r => {
        csv += COLS.map(c => {
            let v = (r[c]||"").toString();
            if(c === "Ativo") v = (v === "Sim" || v === "true") ? "true" : "false";
            return `"${v.replaceAll(/[;]| , /g, ' - ')}"`;
        }).join(",") + "\n";
    });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    link.download = nomeFinal; link.click();
};
/*
// MEDI√á√ÉO
const CustomMeasure = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function() {
        const div = L.DomUtil.create('div', 'leaflet-measure-btn');
        div.innerHTML = `<i class="fa-solid fa-ruler-combined"></i><div class="measure-menu" id="mMenu"><button onclick="startMeasure('line')">Linha</button><button onclick="startMeasure('area')">√Årea</button><button onclick="clearMeasure()" style="color:#f87171">Limpar</button></div>`;
        div.onclick = (e) => { e.stopPropagation(); document.getElementById('mMenu').classList.toggle('active'); };
        return div;
    }
});
map.addControl(new CustomMeasure());
*/
// Cria um elemento de rodap√© personalizado no Leaflet
const mapaStatus = L.control({ position: 'bottomleft' });

mapaStatus.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'map-footer');
    this._div.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    this._div.style.color = 'white';
    this._div.style.padding = '5px 10px';
    this._div.style.fontSize = '12px';
    this._div.style.fontFamily = 'sans-serif';
    this._div.style.borderRadius = '4px';
    this._div.style.marginBottom = '10px';
    this._div.style.display = 'none'; // Come√ßa escondido
    return this._div;
};

mapaStatus.update = function (texto) {
    this._div.innerHTML = texto;
    this._div.style.display = texto ? 'block' : 'none';
};

mapaStatus.addTo(map);
let measureGroup = L.layerGroup().addTo(map), mPoints = [], mShape = null;
function startMeasure(mode) {
    clearMeasure();
    map.on('click', (e) => {
        if(document.getElementById("drawer").classList.contains("active")) return;
        mPoints.push(e.latlng);
        if(mShape) map.removeLayer(mShape);
        if(mode === 'line') {
            mShape = L.polyline(mPoints, {color: '#fbbf24', weight: 4}).addTo(measureGroup);
            if(mPoints.length > 1) {
                let d = 0; for(let i=0; i<mPoints.length-1; i++) d += mPoints[i].distanceTo(mPoints[i+1]);
                mShape.bindTooltip(`${d.toFixed(1)}m`, {permanent:true}).openTooltip();
            }
        } else {
            mShape = L.polygon(mPoints, {color: '#fbbf24', fillOpacity: 0.3}).addTo(measureGroup);
        }
    });
}
function clearMeasure() { map.off('click'); measureGroup.clearLayers(); mPoints = []; mShape = null; document.getElementById('mMenu').classList.remove('active'); }

// DRAWER & GPS
function openDrawer(idx) {
    activateFullscreen();
    selectedIndex = idx; const grid = document.getElementById("drawerGrid"); grid.innerHTML = "";
    COLS.forEach(c => {
        if(c === "Ativo") {
            const v = (filtered[idx][c] === "true" || filtered[idx][c] === "Sim") ? "Sim" : "N√£o";
            grid.innerHTML += `<div><label>${c}</label><select id="inp_${c}"><option value="Sim" ${v==='Sim'?'selected':''}>Sim</option><option value="N√£o" ${v==='N√£o'?'selected':''}>N√£o</option></select></div>`;
        } else grid.innerHTML += `<div><label>${c}</label><input id="inp_${c}" value="${filtered[idx][c]||''}"></div>`;
    });
    document.getElementById("drawer").classList.add("active");
}
function closeDrawer() { document.getElementById("drawer").classList.remove("active"); }
/*
document.getElementById('geoBtn').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
        // Guardamos os n√∫meros para o mapa e as strings para o texto
        const latNum = pos.coords.latitude;
        const lonNum = pos.coords.longitude;
        const latStr = latNum.toFixed(6);
        const lonStr = lonNum.toFixed(6);
        const acc = pos.coords.accuracy.toFixed(1); // Definindo a vari√°vel acc corretamente

        // 1. Cria um marcador tempor√°rio com Tooltip da precis√£o
        const temp = L.marker([latNum, lonNum])
            .addTo(map)
            .bindTooltip(`${acc}m`, { permanent: true })
            .openTooltip();

        // 2. Cria e abre o Popup formatado
        L.popup()
            .setLatLng([latNum, lonNum])
            .setContent(`
                <div style="text-align:center; font-family: sans-serif; color: #000;">
                    <b style="color: #000000;">Sua Localiza√ß√£o</b><br>
                    <hr style="border:0; border-top:1px solid #ccc; margin:5px 0">
                    <b>Lat:</b> ${latStr}<br>
                    <b>Lon:</b> ${lonStr}<br>
                    <small>Precis√£o: <b>${acc}m</b></small>
                </div>
            `)
            .openOn(map);

        // 3. Centraliza o mapa
        map.setView([latNum, lonNum], 18);

        // 4. Aguarda meio segundo para o usu√°rio ver o ponto antes de perguntar
        setTimeout(() => {
            if(confirm(`Adicionar coordenadas de GPS ao formul√°rio?`)) {
                const iL = document.getElementById('inp_Latitude');
                const iO = document.getElementById('inp_Longitude');
                
                // Concatena se j√° houver valor
                iL.value = iL.value ? iL.value + ' - ' + latStr : latStr;
                iO.value = iO.value ? iO.value + ' - ' + lonStr : lonStr;
            }
            // Remove o marcador tempor√°rio e o popup ap√≥s a decis√£o
            map.removeLayer(temp);
            map.closePopup();
        }, 500);

    }, (err) => {
        alert("Erro ao obter GPS: " + err.message);
    }, {
        enableHighAccuracy: true,
        timeout: 10000 // Aumentado para 10s para garantir sinal em locais dif√≠ceis
    });
};
*/
document.getElementById('geoBtn').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const latStr = lat.toFixed(6), lonStr = lon.toFixed(6);
        const acc = pos.coords.accuracy.toFixed(1);

        // 1. Marca√ß√£o visual tempor√°ria
        const temp = L.marker([lat, lon]).addTo(map)
            .bindTooltip(`
                <div style="text-align: left; line-height: 1.2;">
                    <b>Lat:</b> ${latStr}<br>
                    <b>Lon:</b> ${lonStr}<br>
                    <b>Precis√£o:</b> ${acc}m
                </div>
            `, {
                permanent: true, 
                direction: 'top',
                className: 'gps-tooltip' // Classe opcional para estiliza√ß√£o CSS
            }).openTooltip();

        map.setView([lat, lon], 18);

        // 2. Atualiza o rodap√© com a pergunta
        mapaStatus.update(`
            üìç GPS Capturado (${acc}m). Adicionar ao formul√°rio? 
            <button id="gpsSim" style="background:#22c55e; color:white; border:none; padding:4px 12px; cursor:pointer; margin-left:10px; border-radius:4px;">Sim</button>
            <button id="gpsNao" style="background:#ef4444; color:white; border:none; padding:4px 12px; cursor:pointer; margin-left:5px; border-radius:4px;">N√£o</button>
        `);

        // 3. L√≥gica do bot√£o SIM (Sem a mensagem "Adicionar coordenadas?")
        document.getElementById('gpsSim').onclick = () => {
            const iL = document.getElementById('inp_Latitude'), iO = document.getElementById('inp_Longitude');
            
            // Inser√ß√£o direta e silenciosa
            iL.value = iL.value ? iL.value + ' - ' + latStr : latStr;
            iO.value = iO.value ? iO.value + ' - ' + lonStr : lonStr;
            
            limparStatus();
        };

        // 4. L√≥gica do bot√£o N√ÉO
        document.getElementById('gpsNao').onclick = () => {
            limparStatus();
        };

        function limparStatus() {
            if (map.hasLayer(temp)) map.removeLayer(temp);
            mapaStatus.update(""); // Esconde o rodap√© imediatamente
        }

    }, (err) => {
        alert("Erro ao obter GPS: " + err.message);
    }, {enableHighAccuracy:true, timeout: 10000});
};
/*on('click', (e) => {
    if (document.getElementById("drawer").classList.contains("active")) {
        const lat = e.latlng.lat.toFixed(6), lon = e.latlng.lng.toFixed(6);
        const tempM = L.marker(e.latlng).addTo(map).bindTooltip(`${lat}, ${lon}`, {permanent:true}).openTooltip();
        setTimeout(() => {
            if(confirm(`Adicionar coordenadas?`)) {
                const iL = document.getElementById('inp_Latitude'), iO = document.getElementById('inp_Longitude');
                iL.value = iL.value ? iL.value + ' - ' + lat : lat;
                iO.value = iO.value ? iO.value + ' - ' + lon : lon;
            }
            map.removeLayer(tempM);
        }, 100);
    }
});
*/

// UPLOAD & CONTROLES GERAIS
document.getElementById('uploadBtn').onclick = () => document.getElementById('csvFile').click();
document.getElementById('csvFile').onchange = async e => {
    const file = e.target.files[0]; if(!file) return;
    nomeArquivoOriginal = file.name; const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const head = lines[0].split(","); const m = {}; COLS.forEach(c => m[c] = head.indexOf(c));
    tabelaGeo = lines.slice(1).map(l => {
        const v = l.split(","); let o = {};
        COLS.forEach(c => {
            let val = (m[c]!==-1 && v[m[c]]) ? v[m[c]].replace(/["']/g, '').trim() : "";
            if(c === "Ativo") val = (val === "true" || val === "Sim") ? "Sim" : "N√£o";
            o[c] = val;
        });
        return o;
    });
    filtered = [...tabelaGeo]; renderTable();
};

document.getElementById('plotAllBtn').onclick = () => {
    // 1. Verifica quantos registros est√£o atualmente vis√≠veis no mapa
    const totalAtivos = Object.keys(camadasAtivas).length;

    if (totalAtivos > 0) {
        // 2. Se houver algo plotado, vamos LIMPAR TUDO
        Object.keys(camadasAtivas).forEach(idx => {
            // Chamamos a fun√ß√£o toggleRegistro que voc√™ j√° tem para remover a camada
            toggleRegistro(filtered[idx], idx);
        });
        // Adicione isso dentro do 'if (totalAtivos > 0)'
        document.getElementById('plotAllBtn').style.background = "var(--accent)";
    } else {
        // 3. Se o mapa estiver vazio, vamos PLOTAR TUDO
        filtered.forEach((r, i) => {
            // S√≥ plota se j√° n√£o estiver ativo (evita duplicados)
            if (!camadasAtivas[i]) {
                toggleRegistro(r, i);
            }
        });
        
        // Opcional: Ajustar o zoom para mostrar todos os pontos novos
        if (filtered.length > 0) {
            const group = new L.featureGroup(Object.values(camadasAtivas).flat());
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
        document.getElementById('plotAllBtn').style.background = "#1d4ed8"; // Azul vibrante quando ativo
    }
};

document.getElementById('addBtn').onclick = () => { 
    tabelaGeo.push({Tipo: "(Linha / Quadrado / Ponto / Pol√≠gono)", Equipamento: "", Ativo: "Sim", Azimute: "", Latitude: "", Longitude: ""}); 
    filtered = [...tabelaGeo]; renderTable(); openDrawer(filtered.length-1); 
};

// Fun√ß√£o de valida√ß√£o dedicada
function validarCampos(dados) {
    const { Tipo, Equipamento, Latitude, Longitude } = dados;

    // 1. Verifica√ß√£o de Campos Vazios
    if (!Tipo || !Equipamento || !Latitude || !Longitude) {
        alert("Erro: Os campos Tipo, Equipamento, Latitude e Longitude s√£o obrigat√≥rios.");
        return false;
    }

    // 2. Valida√ß√£o do Sufixo do Tipo
    const sufixosValidos = ["(linha)", "(ponto)", "(ret√¢ngulo)", "(c√≠rculo)", "(ponto/pol√≠gono)", "(pol√≠gono)"];
    const tipoValido = sufixosValidos.some(sufixo => Tipo.trim().toLowerCase().endsWith(sufixo.toLowerCase()));
    
    if (!tipoValido) {
        alert("Erro: O campo 'Tipo' deve terminar com um dos sufixos permitidos:\n(inha), (ponto), (ret√¢ngulo), (c√≠rculo), (ponto/pol√≠gono) ou (pol√≠gono)");
        return false;
    }

    // 3. Valida√ß√£o de Coordenadas Longas (Separadores)
    const validarCoordenada = (valor, nomeCampo) => {
        const str = valor.toString();
        if (str.length > 10) {
            if (!str.includes(' - ') && !str.includes(';')) {
                alert(`Erro no campo ${nomeCampo}: Para coordenadas longas, utilize os separadores ' - ' ou ';'`);
                return false;
            }
        }
        return true;
    };

    if (!validarCoordenada(Latitude, "Latitude") || !validarCoordenada(Longitude, "Longitude")) {
        return false;
    }

    return true; // Passou em todas as valida√ß√µes
}

// Evento onsubmit atualizado
document.getElementById('drawerForm').onsubmit = e => {
    e.preventDefault();

    // 1. Coleta os dados dos inputs
    let novosDados = {};
    COLS.forEach(c => {
        novosDados[c] = document.getElementById('inp_' + c).value.trim();
    });

    const { Tipo, Equipamento, Latitude, Longitude } = novosDados;

    // --- BLOCO DE VALIDA√á√ÉO ---
    
    // Fun√ß√£o auxiliar para mostrar erro no rodap√©
    const mostrarErro = (msg) => {
        mapaStatus.update(`<span style="color: #f87171;">‚ö†Ô∏è ${msg}</span>`);
        setTimeout(() => mapaStatus.update(""), 5000); // Some ap√≥s 5 segundos
    };

    // A. Verifica√ß√£o de Campos Vazios
    if (!Tipo || !Equipamento || !Latitude || !Longitude) {
        mostrarErro("Campos Tipo, Equipamento, Lat e Lon s√£o obrigat√≥rios.");
        return;
    }

    // B. Valida√ß√£o do Sufixo do Tipo
    const sufixosValidos = ["(linha)", "(ponto)", "(ret√¢ngulo)", "(c√≠rculo)", "(ponto/pol√≠gono)", "(pol√≠gono)"];
    const tipoValido = sufixosValidos.some(suf => Tipo.toLowerCase().endsWith(suf));
    
    if (!tipoValido) {
        mostrarErro("O Tipo deve terminar com " + sufixosValidos);
        return;
    }

    // C. Valida√ß√£o de Coordenadas Longas (Separadores)
    const validarCoord = (valor) => {
        const str = valor.toString();
        return str.length <= 10 || str.includes(' - ') || str.includes(';');
    };

    if (!validarCoord(Latitude) || !validarCoord(Longitude)) {
        mostrarErro("Use ' - ' ou ';' para separar m√∫ltiplas coordenadas.");
        return;
    }

    // --- SE PASSAR NA VALIDA√á√ÉO, SALVA ---
    COLS.forEach(c => {
        filtered[selectedIndex][c] = novosDados[c];
    });

    renderTable();
    closeDrawer();
    
    // Feedback de sucesso no rodap√©
    mapaStatus.update(`<span style="color: #4ade80;">‚úÖ Registro salvo com sucesso!</span>`);
    setTimeout(() => mapaStatus.update(""), 3000);
};
document.getElementById('search').oninput = e => {
    const val = e.target.value.toLowerCase();
    filtered = tabelaGeo.filter(r => Object.values(r).some(v => v.toString().toLowerCase().includes(val)));
    renderTable();
};

function mostrarAlerta(msg) {
    const el = document.getElementById('customAlert');
    el.innerText = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}
</script>
</body>
</html>
